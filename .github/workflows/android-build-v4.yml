name: Build Android APK v4 (with Gradle Action)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.0'
        
    - name: Install Yarn
      run: npm install -g yarn
        
    - name: Install Capacitor packages (root)
      run: |
        echo "Installing Capacitor dependencies..."
        yarn install
        echo "âœ… Capacitor packages installed"
        
    - name: Install frontend dependencies
      run: |
        echo "Installing frontend dependencies..."
        cd frontend
        yarn install
        echo "âœ… Frontend dependencies installed"
        
    - name: Build React application
      run: |
        echo "Building React app..."
        cd frontend
        CI=false GENERATE_SOURCEMAP=false yarn build
        echo "âœ… React build complete"
        
    - name: Sync Capacitor
      run: |
        echo "Syncing Capacitor with Android..."
        npx cap sync android
        echo "âœ… Capacitor synced"
        
    - name: Verify Android project
      run: |
        echo "Checking Android project structure..."
        ls -la android/
        ls -la android/app/
        
    - name: Setup Gradle Wrapper
      run: |
        cd android
        gradle wrapper
        chmod +x gradlew
        
    - name: Build Android Debug APK
      run: |
        echo "Building Android APK with Gradle..."
        cd android
        ./gradlew assembleDebug --no-daemon --stacktrace --info
        echo "âœ… APK built successfully!"
        
    - name: Find and verify APK
      run: |
        echo "Searching for APK files..."
        find android -name "*.apk" -type f
        APK_PATH=$(find android -name "app-debug.apk" -type f | head -n 1)
        if [ -f "$APK_PATH" ]; then
          echo "âœ… APK found: $APK_PATH"
          ls -lh "$APK_PATH"
        else
          echo "âŒ APK not found!"
          exit 1
        fi
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7
        
    - name: Build Summary
      run: |
        echo "### ðŸŽ‰ Android APK Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Type:** Debug" >> $GITHUB_STEP_SUMMARY
        echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ **Download APK:** See Artifacts section above" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“± **Installation:**" >> $GITHUB_STEP_SUMMARY
        echo "- Download the artifact ZIP" >> $GITHUB_STEP_SUMMARY
        echo "- Extract app-debug.apk" >> $GITHUB_STEP_SUMMARY
        echo "- Transfer to Android device" >> $GITHUB_STEP_SUMMARY
        echo "- Install (enable Unknown Sources if needed)" >> $GITHUB_STEP_SUMMARY
